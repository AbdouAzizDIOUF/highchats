import {
  ChangeDetectionStrategy,
  Component,
  computed,
  DestroyRef,
  effect,
  inject,
  OnInit,
  signal
} from '@angular/core';
import { FormControl, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
import { NeoTextHelperComponent } from '@bpce/neo-ng/text-helper';
import { InformationPromptLayoutComponent } from '@bpce/ng-subscription-ui/information-prompt-layout';
import { NeoButtonComponent, NeoButtonGroupComponent } from '@bpce/neo-ng/button';
import { NeoSliderComponent } from '@bpce/neo-ng/slider';
import { SAISIE_PARTS_WORDING } from '@app/constants/wording/saisie-parts-wording.constant';
import { NeoCardComponent } from '@bpce/neo-ng/card';
import { NeoDialogModule, NeoDialogService } from '@bpce/neo-ng/dialog';
import { takeUntilDestroyed, toSignal } from '@angular/core/rxjs-interop';
import { switchMap } from 'rxjs';
import { PdfViewModalComponent } from '../modals/pdf-view-modal/pdf-view.modal.component';
import { UpdateAmountModalComponent } from '../modals/update-amount-modal/update-amount.modal.component';
import { NeoInputAmountComponent } from '@bpce/neo-ng/input-amount';
import { StepRouteEnum } from '@app/routes';
import { Router } from '@angular/router';
import { BapiStoreService } from '@app/services/store/bapi.store.service';
import { NestedKeys, WordingPipe } from '@bpce/ng-subscription-ui/utils';
import { CurrencyPipe } from '@angular/common';
import { InputStoreService } from '@app/services/store/input.store.service';
import { BapiStore } from '@bpce/ng-subscription-services/bapi/store';
import { DigitalParameters } from '@app/models/digital-parameters';
import { NeoShimmeringComponent } from '@bpce/neo-ng/shimmering';
import { TrackingService } from '@bpce/ng-subscription-services/tracking';
import { SAISIE_PART_PAGE_DATALAYER } from '@app/constants/tracking/tracking.constant';

@Component({
  selector: 'app-saisie-parts',
  templateUrl: './saisie-parts.component.html',
  styleUrl: './saisie-parts.component.scss',
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [
    InformationPromptLayoutComponent,
    NeoButtonComponent,
    NeoButtonGroupComponent,
    NeoSliderComponent,
    NeoTextHelperComponent,
    ReactiveFormsModule,
    NeoCardComponent,
    NeoDialogModule,
    NeoInputAmountComponent,
    WordingPipe,
    CurrencyPipe,
    NeoShimmeringComponent
  ]
})
export class SaisiePartsComponent implements OnInit {

  protected displayHelper: boolean = false;
  protected showShimmering: boolean = false;

  protected helperKey: NestedKeys<typeof SAISIE_PARTS_WORDING> =
    'form.helper.infoAmount';
  protected helperAmount: number = 0;
  protected rawInputValue: number = 0;
  protected maximumAllowedAmount: number = 0;
  protected maximumAllowedParts: number = 0;

  readonly template = SAISIE_PARTS_WORDING;

  private readonly trackingService = inject(TrackingService);
  private readonly neoDialog = inject(NeoDialogService);
  private readonly destroyRef = inject(DestroyRef);
  private readonly router = inject(Router);
  private readonly bapiStore = inject(BapiStoreService);
  private readonly inputStore = inject(InputStoreService);
  private readonly bapiStoreParam: BapiStore<DigitalParameters> = inject(BapiStore);

  private readonly CENT_RATIO = 100;


  protected showValue: boolean = false;
  readonly isInputFocused = signal(false);
  readonly shareData = computed(() => {
    const condition = this.bapiStore.conditionSocialShare.value();
    const selectedAccount = this.bapiStore.selectedAccount();
    const shareAmount = this.bapiStore.shareAmount();


    if (condition && selectedAccount) {

      let balance: number | undefined = this.inputStore.accountSelected()?.balance;
      if (balance) {
        this.maximumAllowedParts = Math.floor(balance / selectedAccount.shareAmount.value);
        this.maximumAllowedAmount = this.maximumAllowedParts * selectedAccount.shareAmount.value;
      }


      return {
        shareAmount: shareAmount,
        miniAmount:
          condition.characteristics.minimumShareNumber *
          selectedAccount.shareAmount.value,
        maxAmount: condition.characteristics.remainingAmountToInvest.value,
        minParts: condition.characteristics.minimumShareNumber,
        maxParts: Math.floor(
          condition.characteristics.remainingAmountToInvest.value /
          selectedAccount.shareAmount.value
        )
      };
    }
    return undefined;
  });

  readonly selectedShareAmount = signal(0);
  protected supportsPdfViewer: boolean = navigator.pdfViewerEnabled;


  precision = computed(() => {
    const data = this.shareData();
    if (
      data !== undefined &&
      Number.isInteger(this.selectedShareAmount() * data.shareAmount) &&
      !this.isInputFocused()
    ) {
      return 0;
    }
    return 2;
  });

  public readonly getNoticeLink = computed(() => {
    return this.bapiStoreParam.digitalParameters.value()?.links
      .technicalNoticeLink;
  });


  readonly formGroup = new FormGroup({
    input: new FormControl<any>(this.shareData()?.miniAmount, [
      Validators.required
    ])
  });

  readonly formValue = toSignal(this.formGroup.valueChanges, {
    initialValue: this.formGroup.value
  });
  readonly formStatus = toSignal(this.formGroup.events);

  get inputValue(): number {
    return this.formGroup.get('input')?.value || this.shareData()?.miniAmount;
  }

  set inputValue(value: number | null) {
    const data = this.shareData();
    if (value !== null && data !== undefined) {
      this.closestShareNumberfromAmount(value);
      this.displayHelper = false;
      this.formGroup.get('input')?.markAsDirty();
    }
  }

  constructor() {
    effect(() => {
      if (this.precision() !== 0) {
        this.formGroup.get('input')?.setValue(this.inputValue);
      }
    });
  }

  ngOnInit(): void {
    this.trackPage();
    this.initShares();
  }

  onValueChange(_$event: any) {
    this.showShimmering = false;
    let value = this.formGroup.get('input')?.value;
    this.rawInputValue = value;
    this.getHelpers(value);
    this.isInputFocused.set(false);
    const data = this.shareData();
    if (value && data !== undefined) {
      value = this.closestShareNumberfromAmount(value);
      const lowerMultiple =
        Math.floor(value / data.shareAmount) * data.shareAmount;
      const upperMultiple =
        Math.ceil(value / data.shareAmount) * data.shareAmount;

      let closestMultiple =
        value - lowerMultiple < upperMultiple - value
          ? lowerMultiple
          : upperMultiple;

      closestMultiple = this.roundAmountApproximation(closestMultiple);

      if (value !== closestMultiple) {
        this.formGroup.get('input')?.setValue(closestMultiple);
      }
      this.showValue = !!this.formValue().input;
      this.displayHelper = (
        !data ||
        value <= data.miniAmount ||
        value >= data.maxAmount
      );
      this.isInputFocused.set(false);
    }
  }

  onInputChange(event: any) {
    const inputElement = event.target as HTMLInputElement;
    this.rawInputValue = Number.parseFloat(inputElement.value);
    this.showShimmering = true;
  }

  getHelpers(value: number) {
    if (value > this.shareData()!.maxAmount) {
      this.helperAmount = this.shareData()!.maxAmount;
      this.helperKey = 'form.helper.infoAmountMax';
    } else if (value < this.shareData()!.miniAmount) {
      this.helperAmount = this.shareData()!.miniAmount;
      this.helperKey = 'form.helper.infoAmountMin';
    } else {
      this.helperAmount = this.shareData()!.shareAmount;
      this.helperKey = 'form.helper.inputErreur';
    }
  }

  clear() {
    const data = this.shareData();
    if (data) {
      this.formGroup.reset({ input: data.miniAmount }, { emitEvent: true });
    }
  }

  initShares() {
    const shareNumber = this.inputStore.shareNumber();
    const data = this.shareData();
    if (data && shareNumber && shareNumber > 0) {
      this.selectedShareAmount.set(shareNumber);
      this.formGroup.get('input')?.setValue(shareNumber * data.shareAmount);
      this.formGroup.get('input')?.markAsDirty();
      this.showValue = true;
    }
  }

  openDefault(): void {
    this.neoDialog
      .open(PdfViewModalComponent)
      .pipe(
        switchMap((ref) => ref.afterClose()),
        takeUntilDestroyed(this.destroyRef)
      )
      .subscribe();
  }

  continue() {
    const data = this.shareData();
    let balance: number | undefined =
      this.inputStore.accountSelected()?.balance;
    if (data) {
      if (
        balance &&
        (this.formGroup.get('input')?.value > data.maxAmount ||
          this.formGroup.get('input')?.value > balance)
      ) {
        this.neoDialog
          .open(UpdateAmountModalComponent, {
            data: {
              maximumAllowedAmount: this.maximumAllowedAmount,
              maximumAllowedParts: this.maximumAllowedParts
            }
          })
          .pipe(
            switchMap((ref) => ref.afterClose()),
            takeUntilDestroyed(this.destroyRef)
          )
          .subscribe();
      } else {
        if (this.selectedShareAmount() < data.minParts) {
          this.selectedShareAmount.set(data.minParts);
        } else if (this.selectedShareAmount() > data.maxParts) {
          this.selectedShareAmount.set(data.maxParts);
        }

        this.inputStore.setShareNumberSelected(this.selectedShareAmount());
        this.router.navigate([StepRouteEnum.QUESTION_INTRO]);
      }
    }
  }

  getTitle(): NestedKeys<typeof SAISIE_PARTS_WORDING> {
    const data = this.shareData();
    if (data) {
      if (this.formValue().input === data.miniAmount) {
        return 'header.title.default';
      }
    }
    if (!this.formStatus()) {
      return 'header.title.default';
    }
    if (this.formValue().input) {
      this.showValue = true;
      return this.showShimmering
        ? 'header.title.editedShimmering'
        : 'header.title.edited';
    } else {
      this.showValue = false;
      return 'header.title.default';
    }
  }

  trackPage() {
    this.trackingService.trackPage(SAISIE_PART_PAGE_DATALAYER);
  }

  private closestShareNumberfromAmount(value: number): number {
    const data = this.shareData();
    let finalValue = value;
    if (value && data !== undefined) {
      if (value > data.maxAmount) {
        this.displayHelper = true;
        finalValue = data.maxAmount;
      } else if (value < data.miniAmount) {
        this.displayHelper = true;
        finalValue = data.miniAmount;
      }
      this.formGroup.get('input')?.setValue(finalValue);

      this.selectedShareAmount.set(Math.floor(finalValue / data.shareAmount));
    }
    return finalValue;
  }

  private roundAmountApproximation(amount: number) {
    return Math.round(amount * this.CENT_RATIO) / this.CENT_RATIO;
  }
}



@if ((!formGroup.get('input')?.pristine) && showValue) {
  <p class="amount">{{ inputValue | currency: 'EUR' : 'symbol' : '1.2-2' }} </p>
}
@if (showShimmering) {
  <div class="shimmering">
    <p>Soit&nbsp;</p>
    <neo-shimmering
      [shape]="'line'"
      aria-label="Chargement en cours"
      class="shimmering-data-line"
    />
    <p>&nbsp;parts sociales</p>
  </div>
}
<lib-information-prompt-layout
  [description]="
    'header.description'
      | wording
        : {
            wording: template,
            replacement: {
              SHARE_AMOUNT:
                this.shareData()?.shareAmount
                | currency: 'EUR' : 'symbol' : '1.2-2',
            },
          }
  "
  [title]="
    getTitle()
      | wording
        : {
            wording: template,
            replacement: { MAX_AMOUNT: selectedShareAmount() },
          }
  "
>
  <div class="container">
    <form [formGroup]="formGroup">
      <neo-input-amount
        #input
        (blur)="onValueChange($event)"
        (focus)="isInputFocused.set(true)"
        (input)="onInputChange($event)"
        [precision]="precision()"
        (clear)="clear()"
        [size]="'l'"
        class="neo-slider-with-input"
        formControlName="input"
        label="Montant"
      >
        @if (displayHelper) {
          <neo-text-helper type="warning" [iconAriaLabel]="'warning'"
          >{{
              helperKey
                | wording
                : {
                  wording: template,
                  replacement: {
                    HELPER_AMOUNT:
                      helperAmount | currency: "EUR" : "symbol" : "1.2-2",
                  },
                }
            }}
          </neo-text-helper>
        } @else {
          <neo-text-helper type="default" [iconAriaLabel]="'default'">
            {{
              "form.helper.infoAmount"
                | wording
                : {
                  wording: template,
                  replacement: {
                    SHARE_AMOUNT:
                      shareData()?.shareAmount
                        | currency: "EUR" : "symbol" : "1.2-2",
                  },
                }
            }}
          </neo-text-helper>
        }
      </neo-input-amount>
    </form>
    
    <neo-slider
      (valueChange)="inputValue = $event"
      [ariaLabel]="''"
      [maxLabel]="' '"
      [max]="shareData()?.maxAmount || 0"
      [minLabel]="' '"
      [min]="shareData()?.miniAmount || 0"
      [precision]="2"
      [step]="shareData()?.shareAmount || 0"
      [value]="inputValue"
    />

    <div class="helpers">
      <neo-text-helper type="default"
      >{{ shareData()?.miniAmount | currency: "EUR" : "symbol" : "1.2-2" }}
      </neo-text-helper>
      <neo-text-helper type="default"
      >{{ shareData()?.maxAmount | currency: "EUR" : "symbol" : "1.2-2" }}
      </neo-text-helper>
      <neo-text-helper type="default"
      >{{
          "form.helper.shareSlider"
            | wording
            : {
              wording: template,
              replacement: {NUMBER_SHARE: shareData()?.minParts},
            }
        }}
      </neo-text-helper>
      <neo-text-helper type="default"
      >{{
          "form.helper.shareSlider"
            | wording
            : {
              wording: template,
              replacement: {NUMBER_SHARE: shareData()?.maxParts},
            }
        }}
      </neo-text-helper>
    </div>

    <div neoCard>
      <div class="slot-content">
        <p class="info-title">{{ template.infobox.title }}</p>
        <p class="bullet">{{ template.infobox.bullet1 }}</p>
        @if (supportsPdfViewer) {
          <button
            class="download"
            neoButton
            [variant]="'secondary-outline'"
            [iconPosition]="'right'"
            [icon]="'download'"
            aria-haspopup="dialog"
            (click)="openDefault()"
          >
            {{ template.infobox.download }}
          </button>
        } @else {
          <a
            class="download"
            neoButton
            [iconPosition]="'right'"
            [variant]="'secondary-outline'"
            [icon]="'download'"
            [href]="getNoticeLink()"
          >
            {{ template.infobox.download }}
          </a>
        }
        <p class="bullet">{{ template.infobox.bullet2 }}</p>
      </div>
    </div>
  </div>
  <div cta>
    <div [alignment]="'block'" neoButtonGroup>
      <button (click)="continue()" alignment="block" neoButton
              [disabled]="formGroup.invalid || formGroup.get('input')?.value <= 0">
        {{ template.action }}
      </button>
    </div>
  </div>
</lib-information-prompt-layout>

